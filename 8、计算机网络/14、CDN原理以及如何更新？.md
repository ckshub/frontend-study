	什么是CDN，CDN就是，内容分发网络，它是一组分布在多个不同地理位置的 Web 服务器。我们都知道，当服务器离用户越远时，延迟越高。CDN 就是为了解决这一问题，在多个位置部署服务器，让用户离服务器更近，从而缩短请求时间。

## CDN原理：

​	当用户访问一个网站时，如果没有 CDN，过程是这样的：

​	1.浏览器要将域名解析为 IP 地址，所以需要向本地 DNS 发出请求。

2.本地 DNS 依次向根服务器、顶级域名服务器、权限服务器发出请求，得到网站服务器的 IP 地址。

3.本地 DNS 将 IP 地址发回给浏览器，浏览器向网站服务器 IP 地址发出请求并得到资源。

#### 过程

如果用户访问的网站部署了 CDN，过程是这样的：

1.浏览器要将域名解析为 IP 地址，所以需要向本地 DNS 发出请求。

2.本地 DNS 依次向根服务器、顶级域名服务器、权限服务器发出请求，得到全局负载均衡系统（GSLB）的 IP 地址。

3.本地 DNS 再向 GSLB 发出请求，GSLB 的主要功能是根据本地 DNS 的 IP 地址判断用户的位置，筛选出距离用户较近的本地负载均衡系统（SLB），并将该 SLB 的 IP 地址作为结果返回给本地 DNS。

4.本地 DNS 将 SLB 的 IP 地址发回给浏览器，浏览器向 SLB 发出请求。

5.SLB 根据浏览器请求的资源和地址，选出最优的缓存服务器发回给浏览器。

6.浏览器再根据 SLB 发回的地址重定向到缓存服务器。

7.如果缓存服务器有浏览器需要的资源，就将资源发回给浏览器。如果没有，就向源服务器请求资源，再发给浏览器并缓存在本地。



## 什么时候不使用cdn

你到底要不要用CDN呢

- 几种明确不该用CDN的情况
  1. 你构建的是内部网络应用，不与外部Internet连接；
  2. 像银行系统这样的应用，安全和隐私是最优先考虑的，就要让所有源文件和服务器位置完全处于自己掌控中；
  3. 你为公司或者国家开发的应用，而他们恰好对某些CDN的域名或者IP地址限制访问。
  4. 动态资源

- CDN对低流量的小网站性能提升并不明显，如果没有需要高带宽的视频、音频文件，把你的文件放在一起可能还更简单。
- 对流量高的网站，CDN可以大大提升性能，但假如你的用户以移动设备为主，可能自己优化过的小文件比CDN上的大文件要下载和执行的更快。
- 在实际中通过JavaScript搜集用户分别使用CDN文件和本地服务器文件时加载页面的速度，以决定一段时间内是选择CDN还是本地文件。
- 对于重要的文件，最好还是提供本地文件的冗余，以应对CDN文件不可用的情况。以jquery为例：
```js
<script src="https://ajax.googleapis.com/ajax/libs/jquery1.4.3/jquery.min.js"></script>
<script>!window.jQuery && document.write("<script src=\"scripts/jquery-1.4.3.min.js\">" + "<\/scrript>")
```
这里通过判断window.jquery全局对象是否存在来判断jQuery是否通过CDN加载成功，不成功就通过document.write方法来加载本地的jQuery文件，注意这里用到了转义字符‘\’避免浏览器将document.write方法内的“</script>”当成了结束标签。



## 什么时候使用cdn

1. 浏览器从服务器上下载css、js和图片等文件时都要和服务器连接，而大部分浏览器对同一个域名用于下载文件的并发连接数限制在4个，这意味着如果要下载第五个文件就必须等前四个文件中有一个已经加载完成，假如前4个文件都很大，第五个文件就要等很久，整个网页的加载速度就受限于此了。**用CDN就可以通过不同的域名来加载文件，从而使下载文件的并发连接数大大增加。**

2. jQuery一类的库文件现在被广泛使用，如果访问你网站的用户的浏览器之前在访问别的网站时通过和你相同的CDN已经加载了jQuery，由于jQuery文件已经被缓存了，就不用重新下载了。
3. 也许你的网站主机性能很好，但是应该不会比Google、Microsoft和Yahoo等大公司的容量和可扩展性更高，他们提供的CDN具有更好的可用性，更低的网络延迟和丢包率。
4. CDN能提供本地的数据中心，这样一来，那些远离你网站主服务器的用户也能就近很快地下载文件。
5. 让你能够连接到特定版本的css文件或者js库文件，可以根据需求请求最新的版本。
6. 很多商业付费的CDN能提供使用报告，这可以作为你自己网站分析报告的补充。
7. CDN能够分配负载，节省带宽，提高你网站的性能，降低你网站托管的成本，通常是免费的。

